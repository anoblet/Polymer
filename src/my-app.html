<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<!-- My imports -->
<link rel="import" href="components/anoblet/my-layout.html">

<link rel="import" href="components/anoblet/global-styles.html">
<link rel="import" href="components/anoblet/my-styles.html">

<!-- Dependencies -->
<link rel="import" href="../bower_components/iron-location/iron-location.html">

<dom-module id="my-app">
    <template>
        <style include="app-style">
            :host {
                @apply(--flex);
                @apply(--flex-grow);
            }
        </style>
        <x-state data="[[state]]"></x-state>
        State: [[state.location.city]]
        Data: [[data.location.city]]
        <!-- Blocks -->
        <my-layout id="layout" data="[[data]]"></my-layout>
        <!-- End Blocks -->

        <!-- Dependencies -->
        <iron-location path="{{path}}" query="{{__query}}" hash="{{__hash}}" url-space-regex={{urlSpaceRegex}}></iron-location>
        <!-- End Dependencies -->
    </template>
    <script>
        (function () {
            window.App = window.App || {}
        })();

        class MyApp extends Polymer.MutableData(Polymer.Element) {
            static get is() {
                return 'my-app';
            }

            static get properties() {
                return {
                    app: {
                        type: Object,
                        value: function () {
                            return this;
                        }
                    },
                    scope: {
                        type: Object,
                        value: () => {
                            return this;
                        }
                    },
                    data: {
                        type: Object,
                        value: {
                            config: {
                                routes: [
                                    {
                                        href: "",
                                        title: "Home",
                                        src: "components/app-home.html",
                                        tag: "app-home"
                                    },
                                    {
                                        href: "city",
                                        title: "City",
                                        src: "components/app-city.html",
                                        tag: "app-city"
                                    },
                                    {
                                        href: "state",
                                        title: "State",
                                        src: "components/app-state.html",
                                        tag: "app-state"
                                    },
                                    {
                                        href: "login",
                                        title: "Login",
                                        src: "components/app-login.html",
                                        tag: "app-login"
                                    },
                                    {
                                        href: "register",
                                        title: "Register",
                                        src: "components/app-register.html",
                                        tag: "app-register"
                                    },
                                    {
                                        href: "page",
                                        title: "Home",
                                        src: "components/app-page.html",
                                        tag: "app-page"
                                    },
                                    {
                                        href: "map",
                                        title: "Home",
                                        src: "components/app-map.html",
                                        tag: "app-map"
                                    },
                                    {
                                        href: "sitemap",
                                        title: "Home",
                                        src: "components/x-sitemap.html",
                                        tag: "x-sitemap"
                                    },
                                    {
                                        href: "address",
                                        title: "Home",
                                        src: "components/x-address.html",
                                        tag: "x-address"
                                    }
                                ]
                            },
                            location: {
                                state: "a"
                            }
                        },
                        notify: true
                    },
                    state: {
                        type: Object,
                    }
                }
            }

            static get observers() {
                return [
                    'dataChanged(data.*)',
                    'stateChanged(state.*)',
                    'pathChanged(path)'
                ]
            }

            constructor() {
                super();

                // Add app instance to the window
                window.App = this;
            }

            connectedCallback() {
                super.connectedCallback();

                // Location
                this.addEventListener('locationChanged', function (e) {
                    this.set('data.location', e.detail);
                    this.shadowRoot.querySelector('my-layout').querySelector('*').data = this.data;
                });
            };

            stateChanged(state) {
                console.log('State changed');
            }

            dataChanged(data) {
                console.log('Data changed');
                this.data = this.data;

                var element = this.shadowRoot.querySelector('my-layout').querySelector('*');
                if (element) {
                    var layout = this.$.layout;
                    layout.querySelector('*').set('data', this.data);
                    //  element.set('data', this.data);
                    element.notifyPath('data');
                }
            }

            pathChanged(path) {
                path = path.slice(1);
                var routes = this.data.config.routes;

                for (var i = 0; i < routes.length; i++) {
                    if (path == routes[i].href) {
                        var route = routes[i];
                    }
                }

                if (route) {
                    Polymer.importHref(this.resolveUrl(route.src), null, true);

                    this._removeElements();
                    var element = document.createElement(route.tag);
                    element.data = this.data;
                    var a = this.shadowRoot.querySelector('my-layout').appendChild(element);
                    // a.set('data', this.data);
                    // this.shadowRoot.querySelector('my-layout').shadowRoot.querySelector('x-content').appendChild(element);
                    // this.$.layout.appendChild(element);
                    // // this.shadowRoot.querySelector("x-content").appendChild(element);
                    // // this._addElement(route.tag);
                    // // document.title = this.$.config.baseTitle + " - " + route.title;
                }
            }

            _removeElements() {
                var element = this.shadowRoot.querySelector('my-layout').querySelector("*");
                if (element) {
                    element.parentNode.removeChild(element);
                }
            }
        }

        window.customElements.define(MyApp.is, MyApp);
    </script>
</dom-module>