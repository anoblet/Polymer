<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="components/anoblet/my-layout.html">

<link rel="import" href="../bower_components/iron-location/iron-location.html">

<dom-module id="my-app">
    <template>
        <style include="app-style">
            :host {
                @apply(--flex);
                @apply(--flex-grow);
            }
        </style>
        <!-- elements -->
        <my-layout data="[[data]]"></my-layout>
        <!-- end elements -->

        <!-- Dependencies -->
        <iron-location path="{{__path}}" query="{{__query}}" hash="{{__hash}}" url-space-regex={{urlSpaceRegex}}></iron-location>
        <!-- End Dependencies -->
    </template>
    <script>
        window.App = window.App || {}

        class MyApp extends Polymer.MutableData(Polymer.Element) {
            static get is() {
                return 'my-app';
            }

            static get properties() {
                return {
                    app: {
                        type: Object,
                        value: function () {
                            return this;
                        }
                    },
                    scope: {
                        type: Object,
                        value: () => {
                            return this;
                        }
                    },
                    config: {
                        type: Object,
                        value: {
                            routes: [
                                {
                                    href: "",
                                    title: "Home",
                                    src: "components/app-home.html",
                                    tag: "app-home"
                                },
                                {
                                    href: "city",
                                    title: "City",
                                    src: "components/app-city.html",
                                    tag: "app-city"
                                },
                                {
                                    href: "state",
                                    title: "State",
                                    src: "components/app-state.html",
                                    tag: "app-state"
                                },
                                {
                                    href: "login",
                                    title: "Login",
                                    src: "components/app-login.html",
                                    tag: "app-login"
                                },
                                {
                                    href: "register",
                                    title: "Register",
                                    src: "components/app-register.html",
                                    tag: "app-register"
                                },
                                {
                                    href: "page",
                                    title: "Home",
                                    src: "components/app-page.html",
                                    tag: "app-page"
                                },
                                {
                                    href: "map",
                                    title: "Home",
                                    src: "components/app-map.html",
                                    tag: "app-map"
                                },
                                {
                                    href: "sitemap",
                                    title: "Home",
                                    src: "components/x-sitemap.html",
                                    tag: "x-sitemap"
                                },
                                {
                                    href: "address",
                                    title: "Home",
                                    src: "components/x-address.html",
                                    tag: "x-address"
                                }
                            ]
                        }
                    },
                    state: {
                        type: Object,
                        value: {}
                    },
                    data: {
                        type: Object,
                        value: {
                            location: {
                                state: "a"
                            }
                        }
                    },
                    subscribers: {
                        type: Array,
                        value: []
                    }
                }
            }

            static get observers() {
                return [
                    'stateChanged(state.*)',
                    'pathChanged(__path)'
                ]
            }

            constructor() {
                super();
                window.App = this;
            }

            connectedCallback() {
                super.connectedCallback();

                // Location
                this.addEventListener('locationChanged', function (e) {
                    var _location = e.detail;
                    this.set('data.location', _location);
                    this.notifyPath('data.location');
                    this.data.location = _location;
                    this.shadowRoot.querySelector('my-layout').data = this.data;
                });
                // this.set('data.location', l);
                // this.notifyPath('data');
                console.log('a');
            };

            stateChanged(state) {
                console.log('Here');
            }

            pathChanged(path) {
                path = path.slice(1);
                var routes = this.config.routes;

                for (var i = 0; i < routes.length; i++) {
                    if (path == routes[i].href) {
                        var route = routes[i];
                    }
                }

                if (route) {
                    Polymer.importHref(this.resolveUrl(route.src), null, true);

                    this._removeElements();
                    var element = document.createElement(route.tag);
                    element.data = this.data;

                    this.shadowRoot.querySelector('my-layout').appendChild(element);
                    // this.shadowRoot.querySelector('my-layout').shadowRoot.querySelector('x-content').appendChild(element);
                    // this.$.layout.appendChild(element);
                    // // this.shadowRoot.querySelector("x-content").appendChild(element);
                    // // this._addElement(route.tag);
                    // // document.title = this.$.config.baseTitle + " - " + route.title;
                }
            }

            _removeElements() {
                var element = this.shadowRoot.querySelector('my-layout').querySelector("*");
                if (element) {
                    element.parentNode.removeChild(element);
                }
            }
        }

        window.customElements.define(MyApp.is, MyApp);
    </script>
</dom-module>