<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="fact-finder">
    <template>
        <iron-ajax url="[[formatUrl()]]" params="[[formatParams()]]" on-response="handleResponse" auto></iron-ajax>
    </template>
    <script>
        class FactFinder extends Polymer.Element {
            static get is() {
                return 'fact-finder';
            }

            static get properties() {
                return {
                    data: {
                        type: Array,
                        notify: true
                    },
                    _dataset: {
                        type: String
                    },
                    geo: {
                        type: String
                    },
                    key: {
                        type: String
                    },
                    language: {
                        type: String,
                        value: "en"
                    },
                    table: {
                        type: String
                    },
                    program: {
                        type: String
                    },
                    response: {
                        type: Object,
                        notify: true
                    },
                    url: {
                        type: String,
                        value: "https://factfinder.census.gov/service"
                    },
                    version: {
                        type: String,
                        value: "v1"
                    }
                }
            }

            formatParams() {
                return {
                    "key": this.key
                }
            }

            formatUrl() {
                console.log("L");
                let url = this.url
                    + "/data/" + this.version
                    + "/" + this.language
                    + "/programs/" + this.program
                    + "/datasets/" + this._dataset
                    + "/tables/" + this.table
                    + "/data";
                if(this.geo) {
                    url += "/" + this.geo;
                }

                return url;
            }

            handleResponse(event) {
                let response = event.detail.response;
                let header = response.data.header;
                let rows = response.data.rows;
                let newResponse = [];
                for(let key in header.cells) {
                    let cell = header.cells[key];

                    let label = cell.categories[Object.keys(cell.categories)[0]].label;
                    let value = rows[0].cells[key].value;

                    let newRow = [label, value];

                    newResponse.push(newRow);
                }
                this.data = data;
                this.response = newResponse;
            }

            stringify(obj) {
                return JSON.stringify(obj);
            }
        }

        window.customElements.define(FactFinder.is, FactFinder);
    </script>
</dom-module>
