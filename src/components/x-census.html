<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="anoblet/v.1.1.1/LocationMixin.html">

<dom-module id="x-census">
    <template>
        <iron-ajax id="ajax" auto url="https://api.census.gov/data/2016/pep/population" params='[[this._getParams()]]' handle-as="json" on-response="handleResponse" debounce-duration="300"></iron-ajax>
        [[location.state]]
        State population: [[location.state.population]]
    </template>
    <script>
        class XCensus extends LocationMixin(Polymer.MutableData(Polymer.Element)) {
            static get is() {
                return 'x-census';
            }

            static get properties() {
                return {
                    /*
                    state: {
                        type: Object,
                        notify: true
                    },
                    */
                    apiKey: {
                        type: String,
                        value: ""
                    },
                    stateCode: {
                        type: String,
                        value: ""
                    },
                    stateCodes: {
                        type: Array,
                        value: () => [
                            {
                                shortName: "NJ",
                                longName: "New Jersey",
                                code: 34
                            },
                            {
                                shortName: "",
                                longName: "New York",
                                code: 36
                            }
                        ]
                    },
                    data: {
                        type: Object,
                        value: {
                            census: {}
                        }
                    }
                }
            }

            static get observers() {
                return [
                    // '_stateChanged(state.user.location.*)',
                    '_locationChanged(location.*)'
                ];
            }

            connectedCallback() {
                super.connectedCallback();

                // this.set('app.user.location.census', this.data);
            }

            _locationChanged() {
                if (this.location.state) {
                    var userState = this.location.state;
                    var stateCode = this.findStateCode(userState);
                    console.log(stateCode);
                    if (!stateCode === this.stateCode) {
                        this.stateCode = stateCode;
                        console.log(this.app);
                        // this.set('state.user.location.census.stateCode', stateCode);

                        console.log(this.state);

                        this.$.ajax.set('params', {
                            get: "POP,GEONAME",
                            for: "state:" + this.stateCode
                        });
                        // this.$.ajax.generateRequest();
                    }
                }
            }

            _getParams() {
                return {
                    'get': "POP,GEONAME",
                    'for': "state:*"
                }
            }

            findStateCode(userState) {
                for (var i = 0; i < this.stateCodes.length; i++) {
                    var stateCode = this.stateCodes[i];
                    // console.log(this.state.user.location.state);
                    if (this.location.state == stateCode.longName) {
                        var code = stateCode.code;
                    }
                }

                return code;
            }

            handleResponse(event) {
                var response = event.detail.response;
                console.log(this.location);
                if (this.location) {
                    console.log(response);
                    // this.location.population = response[1][0];
                    console.log(this.location);
                    // this.location.state.population = response[1][0];
                    // this.set('location.state.population', response[1][0]);
                    // this.notifyPath('location');
                }
                console.log(event.detail.response);
            }
        }

        window.customElements.define(XCensus.is, XCensus);
    </script>
</dom-module>
